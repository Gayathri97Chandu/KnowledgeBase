--------------------------------------------------------------------
-- Load script for the OMOP drug-HOI reference standard used for various 
-- tests and experiments
--
--
-- Authors: Richard D Boyce, Erica Voss
-- 2014/2015
--
-- 3) ssh to the OHDSI dev server, change to the /mnt/vol1/inbound folder
--    and run:
--    nohup psql -U <user name> -h 127.0.0.1 -W -d vocabularyv5 < loadTestDruHOIUniverse.psql


\echo 'Setting up transaction'
START TRANSACTION;
DROP TABLE IF EXISTS LU_REF_SET_HOI_DEF;
DROP TABLE IF EXISTS LU_REF_SET_DRUG_HOI_DEF;
DROP TABLE IF EXISTS LU_AZ_CERT;

CREATE TABLE LU_REF_SET_HOI_DEF (
	ID serial				PRIMARY KEY,
	REFERENCE_SET			TEXT,
	HOI_CONCEPT_ID			INTEGER,
	HOI_CONCEPT_NAME		TEXT,
	CONDITION_CONCEPT_ID	INTEGER,
	CONDITION_CONCEPT_NAME	TEXT,
	NOTES					TEXT
);

CREATE TABLE LU_REF_SET_DRUG_HOI_DEF (
	ID serial			PRIMARY KEY,
	REFERENCE_SET		TEXT,
	HOI_CONCEPT_ID		INTEGER,
	HOI_CONCEPT_NAME	TEXT,
	DRUG_CONCEPT_ID		INTEGER,
	DRUG_CONCEPT_NAME	TEXT,
	GROUND_TRUTH		INTEGER
);

CREATE TABLE LU_AZ_CERT (
	ID serial			PRIMARY KEY,
	GENERIC_NAME		TEXT,
	BRAND_NAMES		TEXT,
	RXNORM_CONCEPT_ID	INTEGER,
	DRUG_CLASS			TEXT,
	THERAPEUTIC_USE		TEXT,
	PUBMED_SEARCH		TEXT,
	RISK_CATEGORY		TEXT,
	RISK_CATEGORY_2		TEXT,
	ROUTE				TEXT
);

ALTER TABLE LU_REF_SET_HOI_DEF 
  OWNER TO rich;
GRANT ALL ON TABLE LU_REF_SET_HOI_DEF  TO public;
GRANT ALL ON TABLE LU_REF_SET_HOI_DEF  TO ohdsi;
GRANT ALL ON TABLE LU_REF_SET_HOI_DEF  TO administrator;
GRANT ALL ON TABLE LU_REF_SET_HOI_DEF  TO developer;

ALTER TABLE LU_REF_SET_DRUG_HOI_DEF 
  OWNER TO rich;
GRANT ALL ON TABLE LU_REF_SET_DRUG_HOI_DEF  TO public;
GRANT ALL ON TABLE LU_REF_SET_DRUG_HOI_DEF  TO ohdsi;
GRANT ALL ON TABLE LU_REF_SET_DRUG_HOI_DEF  TO administrator;
GRANT ALL ON TABLE LU_REF_SET_DRUG_HOI_DEF  TO developer;

ALTER TABLE LU_AZ_CERT
  OWNER TO rich;
GRANT ALL ON TABLE LU_AZ_CERT  TO public;
GRANT ALL ON TABLE LU_AZ_CERT  TO ohdsi;
GRANT ALL ON TABLE LU_AZ_CERT  TO administrator;
GRANT ALL ON TABLE LU_AZ_CERT  TO developer;

COMMIT;

\echo 'Starting transaction'
START TRANSACTION;
\echo 'Loading data into lookup file that defines HOIs '
\copy LU_REF_SET_HOI_DEF (REFERENCE_SET,HOI_CONCEPT_ID,HOI_CONCEPT_NAME,CONDITION_CONCEPT_ID,CONDITION_CONCEPT_NAME,NOTES) from 'LU_REF_SET_HOI_DEF.csv' DELIMITER ',' CSV HEADER;
COMMIT;

\echo 'Starting transaction'
START TRANSACTION;
\echo 'Loading data into lookup file that defines drugs and HOIs '
\copy LU_REF_SET_DRUG_HOI_DEF (REFERENCE_SET,HOI_CONCEPT_ID,HOI_CONCEPT_NAME,DRUG_CONCEPT_ID,DRUG_CONCEPT_NAME,GROUND_TRUTH) from 'LU_REF_SET_DRUG_HOI_DEF.csv' DELIMITER ',' CSV HEADER;
COMMIT;

\echo 'Starting transaction'
START TRANSACTION;
\echo 'Loading data into lookup file that defines drugs and HOIs '
\copy LU_AZ_CERT(GENERIC_NAME, BRAND_NAMES, RXNORM_CONCEPT_ID, DRUG_CLASS, THERAPEUTIC_USE,PUBMED_SEARCH,RISK_CATEGORY,RISK_CATEGORY_2,ROUTE) from 'LU_AZ_CERT.csv' QUOTE '"' DELIMITER ',' CSV HEADER;
COMMIT;